---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { StatusIcon } from "@components/StatusIcon";
import { ArrowIcon } from "@components/icons/Arrow";
import type { IncidentHistory } from "data";
import { incidentHistories } from "data";
import { parseTokyoDate } from "@utils/dayjs";
import { resolveLocale, type Locale } from "@utils/locale";

export async function getStaticPaths() {
  return incidentHistories.map((incident) => ({
    params: { slug: incident.slug },
    props: { incident },
  }));
}

const incident = Astro.props.incident as IncidentHistory | undefined;
const locale = resolveLocale(Astro.request.headers.get("accept-language"));

const translations: Record<
  Locale,
  {
    defaultDescription: string;
    publishedLabel: string;
    updatedLabel: string;
    causeLabel: string;
    resolvedLabel: string;
    unresolved: string;
    etaPrefix: string;
    noEta: string;
    backLink: string;
    notFoundMessage: string;
  }
> = {
  ja: {
    defaultDescription: "TrainLCDサービスの障害情報",
    publishedLabel: "推定障害発生日時:",
    updatedLabel: "最終更新日時:",
    causeLabel: "障害の原因:",
    resolvedLabel: "復旧日時:",
    unresolved: "未復旧",
    etaPrefix: "頃復旧見込み",
    noEta: "復旧見込みなし",
    backLink: "現在の障害情報",
    notFoundMessage: "指定された障害レポートが見つかりませんでした。",
  },
  en: {
    defaultDescription: "Status information for TrainLCD services.",
    publishedLabel: "Estimated incident time:",
    updatedLabel: "Last updated:",
    causeLabel: "Cause:",
    resolvedLabel: "Resolution time:",
    unresolved: "Not resolved",
    etaPrefix: "estimated to recover around",
    noEta: "no ETA",
    backLink: "Current status",
    notFoundMessage: "The requested incident report was not found.",
  },
};

const localeText = translations[locale];

const formatDate = (dateStr: string | null, excludeMinutes = false) => {
  if (!dateStr) {
    return null;
  }
  const date = parseTokyoDate(dateStr);
  if (excludeMinutes) {
    return locale === "ja"
      ? date.format("YYYY/MM/DD H時")
      : date.format("YYYY/MM/DD HH:00");
  }
  return date.format("YYYY/MM/DD HH:mm");
};

const resolvedText = (() => {
  if (!incident) {
    return null;
  }
  if (incident.resolvedAt) {
    return formatDate(incident.resolvedAt);
  }
  const eta = incident.estimatedResolveDate
    ? `${
        locale === "ja"
          ? `${formatDate(incident.estimatedResolveDate, true)}${localeText.etaPrefix}`
          : `${localeText.etaPrefix} ${formatDate(incident.estimatedResolveDate, true)}`
      }`
    : localeText.noEta;
  return `${localeText.unresolved}(${eta})`;
})();

const fallbackTitle =
  locale === "ja" ? "TrainLCDシステムステータス" : "TrainLCD System Status";
const pageTitle = incident
  ? `${incident.title[locale]} - ${fallbackTitle}`
  : fallbackTitle;
const description = incident
  ? incident.description[locale]
  : localeText.defaultDescription;
---

<BaseLayout title={pageTitle} description={description} lang={locale}>
  {
    incident ? (
      <main class="flex flex-col justify-center items-center md:p-8 p-4 md:mt-16 mt-4 md:mb-32 mb-16">
        <div class="flex justify-center flex-col items-center w-full max-w-2xl">
          <StatusIcon status={incident.incidentImpact} className="h-32 w-32" />
          <h1 class="mt-4 font-bold text-2xl text-center whitespace-pre-wrap">
            {incident.title[locale]}
          </h1>
          <p class="mt-4 w-full whitespace-pre-wrap">
            {incident.description[locale]}
          </p>

          <div class="mt-6 w-full flex">
            <p class="font-bold">{localeText.publishedLabel}</p>
            <p class="ml-2">{formatDate(incident.publishedAt)}</p>
          </div>
          <div class="w-full flex">
            <p class="font-bold">{localeText.updatedLabel}</p>
            <p class="ml-2">{formatDate(incident.updatedAt)}</p>
          </div>
          <div class="w-full flex">
            <p class="font-bold">{localeText.causeLabel}</p>
            <p class="ml-2">{incident.cause?.[locale] ?? "-"}</p>
          </div>
          <div class="w-full flex">
            <p class="font-bold">{localeText.resolvedLabel}</p>
            <p class="ml-2">{resolvedText}</p>
          </div>

          <div class="w-full mt-8">
            <a
              class="text-sm font-bold text-gray-600 inline-flex items-center"
              href="/"
            >
              <ArrowIcon className="mr-1" />
              {localeText.backLink}
            </a>
          </div>
        </div>
      </main>
    ) : (
      <main class="flex flex-col justify-center items-center md:p-8 p-4 md:mt-16 mt-4 md:mb-32 mb-16">
        <div class="flex justify-center flex-col items-center">
          <StatusIcon status="unknown" className="h-32 w-32" />
          <h1 class="mt-4 font-bold text-2xl text-center">404 Not Found</h1>
          <h2 class="mt-4 font-bold text-center">
            {localeText.notFoundMessage}
          </h2>
          <div class="mt-4">
            <a
              class="text-sm font-bold text-gray-600 flex items-center"
              href="/"
            >
              {localeText.backLink}
            </a>
          </div>
        </div>
      </main>
    )
  }
</BaseLayout>
